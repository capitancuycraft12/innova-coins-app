<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Innova Coins - Sistema de Monedas Escolares</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/lucide-react@latest"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-slate-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        
        // Iconos de Lucide
        const Icon = ({ name, className = "w-6 h-6" }) => {
            useEffect(() => {
                if (window.lucide) {
                    window.lucide.createIcons();
                }
            }, [name]);
            return <i data-lucide={name} className={className}></i>;
        };

        function InnovaCoinsApp() {
            // NUEVA URL DE GOOGLE APPS SCRIPT ACTUALIZADA
            const API_URL = 'https://script.google.com/macros/s/AKfycbxlKj38n448t7kXHL7oF5DerAzNz3KF_QjTG8Tf33lj0sIqCE9oVJADcQZu4IfBoSyhbQ/exec';
            
            const [students, setStudents] = useState([]);
            const [loading, setLoading] = useState(false);
            const [activeTab, setActiveTab] = useState('registro');
            const [teacherUnlocked, setTeacherUnlocked] = useState(false);
            const [teacherPassword, setTeacherPassword] = useState('');
            
            const [newStudentName, setNewStudentName] = useState('');
            const [newStudentGrade, setNewStudentGrade] = useState('');
            const [selectedStudentId, setSelectedStudentId] = useState('');
            const [coinAmount, setCoinAmount] = useState('');
            const [transactionReason, setTransactionReason] = useState('');

            useEffect(() => {
                loadStudents();
            }, []);

            const loadStudents = async () => {
                setLoading(true);
                try {
                    const response = await fetch(API_URL);
                    const data = await response.json();
                    if (data.success) {
                        setStudents(data.students || []);
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Error al conectar con Google Sheets. Verifica que el script esté publicado como "Cualquier persona".');
                } finally {
                    setLoading(false);
                }
            };

            const registerStudent = async (e) => {
                e.preventDefault();
                setLoading(true);
                try {
                    await fetch(API_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: new URLSearchParams({
                            action: 'registro',
                            nombre: newStudentName,
                            grado: newStudentGrade
                        })
                    });
                    alert('Solicitud de registro enviada con éxito.');
                    setNewStudentName('');
                    setNewStudentGrade('');
                    setTimeout(loadStudents, 2000);
                } catch (error) {
                    alert('Error al registrar alumno.');
                } finally {
                    setLoading(false);
                }
            };

            const processTransaction = async (e) => {
                e.preventDefault();
                setLoading(true);
                try {
                    await fetch(API_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        body: new URLSearchParams({
                            action: 'actualizar',
                            id: selectedStudentId,
                            monto: coinAmount,
                            motivo: transactionReason
                        })
                    });
                    alert('Transacción procesada correctamente.');
                    setCoinAmount('');
                    setTransactionReason('');
                    setTimeout(loadStudents, 2000);
                } catch (error) {
                    alert('Error al procesar la transacción.');
                } finally {
                    setLoading(false);
                }
            };

            const handleTeacherAccess = (e) => {
                e.preventDefault();
                if (teacherPassword === 'Innova2026H') {
                    setTeacherUnlocked(true);
                } else {
                    alert('Clave de profesor incorrecta.');
                }
            };

            return (
                <div className="min-h-screen">
                    {/* Header */}
                    <header className="bg-blue-700 text-white p-6 shadow-md">
                        <div className="max-w-4xl mx-auto flex justify-between items-center">
                            <div className="flex items-center gap-2">
                                <Icon name="coins" className="text-yellow-400 w-8 h-8" />
                                <h1 className="text-2xl font-bold tracking-tight">INNOVA COINS</h1>
                            </div>
                            <button onClick={loadStudents} className="bg-blue-800 p-2 rounded-full hover:bg-blue-900 transition-colors">
                                <Icon name="refresh-cw" className={loading ? "animate-spin" : ""} />
                            </button>
                        </div>
                    </header>

                    {/* Tabs Navigation */}
                    <nav className="flex justify-center bg-white border-b sticky top-0 z-10">
                        {['registro', 'estudiantes', 'profesor'].map(tab => (
                            <button 
                                key={tab}
                                onClick={() => setActiveTab(tab)}
                                className={`px-6 py-4 text-sm font-bold uppercase transition-all ${activeTab === tab ? 'border-b-4 border-blue-600 text-blue-600' : 'text-gray-400 hover:text-gray-600'}`}
                            >
                                {tab}
                            </button>
                        ))}
                    </nav>

                    <main className="max-w-4xl mx-auto p-6">
                        {/* Tab: Registro */}
                        {activeTab === 'registro' && (
                            <div className="bg-white p-8 rounded-2xl shadow-sm border">
                                <h2 className="text-xl font-bold mb-4 text-gray-800 flex items-center gap-2">
                                    <Icon name="user-plus" className="text-blue-600" /> Nuevo Estudiante
                                </h2>
                                <form onSubmit={registerStudent} className="space-y-4">
                                    <input 
                                        type="text" placeholder="Nombre completo" 
                                        className="w-full p-3 border rounded-xl focus:ring-2 focus:ring-blue-500 outline-none"
                                        value={newStudentName} onChange={e => setNewStudentName(e.target.value)}
                                        required
                                    />
                                    <input 
                                        type="text" placeholder="Grado (Ej: 5to A)" 
                                        className="w-full p-3 border rounded-xl focus:ring-2 focus:ring-blue-500 outline-none"
                                        value={newStudentGrade} onChange={e => setNewStudentGrade(e.target.value)}
                                        required
                                    />
                                    <button className="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-xl font-bold transition-colors">
                                        REGISTRARME
                                    </button>
                                </form>
                            </div>
                        )}

                        {/* Tab: Estudiantes */}
                        {activeTab === 'estudiantes' && (
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                {students.length > 0 ? students.map(s => (
                                    <div key={s.id} className="bg-white p-5 rounded-2xl shadow-sm border flex justify-between items-center hover:border-blue-300 transition-colors">
                                        <div>
                                            <p className="font-bold text-gray-800">{s.name}</p>
                                            <p className="text-sm text-gray-500">{s.grade}</p>
                                        </div>
                                        <div className="text-right">
                                            <p className="text-2xl font-black text-yellow-600">{s.balance}</p>
                                            <p className="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Coins</p>
                                        </div>
                                    </div>
                                )) : (
                                    <p className="text-center col-span-full text-gray-500 py-10">No hay estudiantes registrados o cargando...</p>
                                )}
                            </div>
                        )}

                        {/* Tab: Profesor */}
                        {activeTab === 'profesor' && (
                            !teacherUnlocked ? (
                                <div className="bg-white p-8 rounded-2xl shadow-sm border text-center">
                                    <Icon name="lock" className="mx-auto mb-4 text-gray-300 w-12 h-12" />
                                    <h2 className="text-lg font-bold mb-4">Acceso Restringido</h2>
                                    <form onSubmit={handleTeacherAccess}>
                                        <input 
                                            type="password" placeholder="Clave de profesor" 
                                            className="w-full p-3 border rounded-xl mb-4 text-center focus:ring-2 focus:ring-slate-500 outline-none"
                                            value={teacherPassword} onChange={e => setTeacherPassword(e.target.value)}
                                        />
                                        <button type="submit" className="w-full bg-slate-800 hover:bg-slate-900 text-white py-3 rounded-xl font-bold transition-colors">
                                            ENTRAR
                                        </button>
                                    </form>
                                </div>
                            ) : (
                                <div className="bg-white p-8 rounded-2xl shadow-sm border">
                                    <div className="flex justify-between items-center mb-6">
                                        <h2 className="text-xl font-bold">Administrar Monedas</h2>
                                        <Icon name="settings" className="text-gray-400" />
                                    </div>
                                    <form onSubmit={processTransaction} className="space-y-4">
                                        <select 
                                            className="w-full p-3 border rounded-xl bg-white focus:ring-2 focus:ring-green-500 outline-none"
                                            value={selectedStudentId} onChange={e => setSelectedStudentId(e.target.value)}
                                            required
                                        >
                                            <option value="">Seleccionar alumno...</option>
                                            {students.map(s => <option key={s.id} value={s.id}>{s.name} ({s.grade})</option>)}
                                        </select>
                                        <input 
                                            type="number" placeholder="Cantidad (Ej: 10 o -5)" 
                                            className="w-full p-3 border rounded-xl focus:ring-2 focus:ring-green-500 outline-none"
                                            value={coinAmount} onChange={e => setCoinAmount(e.target.value)}
                                            required
                                        />
                                        <input 
                                            type="text" placeholder="Motivo del cambio" 
                                            className="w-full p-3 border rounded-xl focus:ring-2 focus:ring-green-500 outline-none"
                                            value={transactionReason} onChange={e => setTransactionReason(e.target.value)}
                                            required
                                        />
                                        <button className="w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded-xl font-bold transition-colors">
                                            APLICAR CAMBIO
                                        </button>
                                        <button 
                                            type="button"
                                            onClick={() => setTeacherUnlocked(false)} 
                                            className="w-full text-red-500 text-sm mt-4 hover:underline"
                                        >
                                            Cerrar Sesión de Administrador
                                        </button>
                                    </form>
                                </div>
                            )
                        )}
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<InnovaCoinsApp />);
    </script>
</body>
</html>
        root.render(<InnovaCoinsApp />);
    </script>
</body>
</html>
